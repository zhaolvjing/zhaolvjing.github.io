---
layout: post
tags: [正则]
toc: true
---

## 基本概念
正则表达式是一种文本模式，其本质就是利用一些特定字符组成一个“规则字符串”，用于匹配给定的字符串，达到检索、提取、替换等目的。

正则表达式在每种编程语言中都具有相同的概念，整体规则基本一致。本文主要基于 SQL(MaxCompute) 进行测试整理。

## 规则表

### 元字符
| 模式 | 描述 |
| :--: | :-- |
| ^ | 匹配字符串开始的位置 |
| \$ | 匹配字符串结束的位置 |
| . | 匹配任意单个字符，不匹配换行符 |
| [] | 匹配方括号里的任意字符（不关心字符顺序），使用连字符(-)来指定字符集的范围。注：^ 用在方括号中的开头的时候，表示该字符集是否定的 |
| * | 匹配在 * 之前的字符出现 >=0 次 |
| + | 匹配在 + 之前的字符出现 >=1 次 |
| ? | 匹配在 ? 之前的字符出现 0 或 1 次 |
| {m} | 匹配前一个字符 m 次 |
| {n,m} | 匹配前一个字符 n 到 m 次 (n <= num <= m) |
| {,m} | 匹配前一个字符 0 到 m 次 (0 <= num <= m) |
| {n,} | 匹配前一个字符至少 n 次 (n <= num) |
| (xyz) | 匹配与 xyz 完全相等的字符串。被括起来的表达式将作为分组。每遇到一个左括号 ( ，分组编号+1 。分组表达式可接数量词。逻辑或运算符( \| )仅对当前分组有效 |
| \| | 或运算符，匹配符号前或后的字符 |
| \ | 转义字符，用于匹配一些保留的字符。\[ ] ( ) . * + ? ^ $ \ \|

### 简写字符集
| 模式 | 描述 |
| :--: | :-- |
| \t | 匹配一个制表符 |
| \r | 匹配一个换行符 |
| \n | 匹配一个回车符 |
| \f | 匹配一个换页符 |
| \v | 匹配一个垂直制表符 |
| \p | 匹配 CR/LF（等同于 \r\n），用来匹配 DOS 行终止符 |
| \w | 配所有字母、数字、下划线，等同于 [a-zA-Z0-9_] |
| \W | 匹配所有非字母数字及除下划线之外的符号，等同于： [^\w] |
| \d | 匹配数字： [0-9] |
| \D | 匹配非数字： [^\d] |
| \s | 匹配所有空格字符，等同于： [\t\n\f\r\p] |
| \S | 匹配所有非空格字符，等同于：[^\s] |
| \b | 单词边界，即匹配 \w 和 \W 之间的内容 |
| \B | 非单词边界，等同于： [^\b] |
| \A | 仅匹配整个字符串的开头 |
| \Z | 仅匹配整个字符串的结尾 |

### 常用字符集
| 模式 | 描述 |
| :--: | :-- |
| [\\\x{4e00}-\\\x{9fa5}] | 匹配中文字符 |
| [A-Za-z0-9] | 匹配英文字符和数字 |

**说明**

* 正则表达式大小写敏感；
* 单词边界就是单词和符号之间的边界，这里的单词可以是中文字符、英文字符、数字，符号可以是中文符号、英文符号、空格、制表符、换行符等。

**示例**

```sql
-- 匹配中文字符
select
 '张三' rlike '[\\x{4e00}-\\x{9fa5}]'  -- true
,'abc' rlike '[\\x{4e00}-\\x{9fa5}]'  -- false
,'123' rlike '[\\x{4e00}-\\x{9fa5}]'  -- false
,',' rlike '[\\x{4e00}-\\x{9fa5}]'  -- false
;

-- 单词边界(\b)的用法: 字符串 abc 的两边必须是空格
select
 ' abc ' rlike '\\s+\\babc\\b\\s+'  -- true
,'xabcz' rlike '\\s+\\babc\\b\\s+'  -- false
;
```

### 非捕获组和环视
| 模式 | 描述 |
| :--: | :-- |
| (?:...) | 非捕获组：表示这个括号内的内容不作为分组 |
| (?=...) | 肯定环视：表示右边是指定内容的位置 |
| (?!...) | 否定环视：表示右边不是指定内容的位置 |
| (?<=...) | 肯定逆序环视：表示左边是指定内容的位置 |
| (?<!...) | 否定逆序环视：表示左边不是指定内容的位置 |

### 其他
| 模式 | 描述 |
| :--: | :-- |
| (?aiLmsux) | aiLmsux 的每个字符代表一个匹配模式（例如 i 代表忽略大小写），只能在字符串开头使用 |
| (?#...) | 表示注释，将被直接忽略 |

## 匹配模式
常见的匹配模式有三张：贪婪模式、非贪婪模式、独占模式。简单来讲：贪婪模式就是尽可能匹配更多的字符，非贪婪模式则是尽可能匹配最少的字符，这两种匹配模式会产生不同的匹配结果。不管是贪婪模式，还是非贪婪模式，都需要发生回溯才能完成相应的功能。回溯算法是正则表达式里最重要的一种算法思想，依次考察正则表达式中的每个字符，非通配符时就直接跟文本的字符进行匹配，相同则继续往下处理；不同则回溯。
### 贪婪模式
* 当只使用 * 进行匹配时，则就是贪婪模式

```sql
select 'abcbcbc' rlike 'a.*bc';  -- bcbc
```

### 非贪婪模式
* 当使用 *? 进行匹配时，则就是非贪婪模式

```sql
select 'abcbcbc' rlike 'a.*?bc';  -- (空串)
```

### 独占模式
在一些场景下，我们不需要回溯，匹配不上返回失败就好了，因此正则中还有另外一种模式：独占模式，它类似贪婪匹配会尽可能多地去匹配，但匹配失败就结束，不会进行回溯。因此在一些场合下性能会更好 。

## 实战场景
* 匹配手机号：`1(?:[38]\\d|4[579]|5[0-35-9]|7[0-35-8])\\d{8}`
* 匹配邮箱：`[a-z.-]+@[a-zA-Z0-9]+(\.[a-zA-Z]+){1,3}`
* 匹配身份证号：`(^\\d{8}(0\\d|10|11|12)([0-2]\\d|30|31)\\d{3}$)|(^\\d{6}(18|19|20)\\d{2}(0[1-9]|10|11|12)([0-2]\\d|30|31)\\d{3}(\\d|X|x)$)`
